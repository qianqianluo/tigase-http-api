<%  def action = request.getParameter('action');
	if (action) {
		String redirectUrl = null;
		if (action == 'reload') {
			redirectUrl = request.getRequestURI() + "?" + request.getQueryString().replace('&action=reload','');
			def f =  new File("etc/init.properties");
			if (f.exists()) {
				def reader = f.newReader();
				def props = new java.util.Properties();
				props.load(reader);
				
				config.clear();
				props.stringPropertyNames().each { key ->
					if ("config-type".equals(key)) {
						config['configType'] = props.get(key);
					} else if ("--virt-hosts".equals(key)) {
						config['virtualDomains'] = props.get(key);
					} else if ("--admins".equals(key)) {
						config['admins'] = props.get(key);
					} else if ("--user-db-uri".equals(key)) {
						def uri = props.get(key);
						def dbType = ( uri =~ /:([^:]+):/ )[0][1];
						if (dbType == 'mysql') dbType = "MySQL";
						if (dbType == 'postgresql') dbType = 'PostgreSQL';
						if (dbType == 'derby') dbType = 'Derby';
						if (dbType == 'sqlserver') dbType = 'SQLServer';
						config['dbType'] = dbType;
						config['dbHost'] = ( uri =~ /\/\/([^\/]+)\// )[0][1];
						config['dbName'] = ( uri =~ /\/([^\/\?]+)\?/ )[0][1];
						config['dbUser'] = ( uri =~ /\?user=([^\&]+)&/ )[0][1];
						config['dbPass'] = ( uri =~ /&password=([^\&]+)/ )[0][1];
					} else if (key.startsWith('--comp-class')) {
						def value = props.get(key);
						if (value.contains('PubSub')) config.PubSubComponent = true;
						if (value.contains('MUC')) config.mucComponent = true;
						if (value.contains('Stun')) confg.stunComponent = true;
						if (value.contains('Socks5')) config.socks5Component = true;
						if (value.contains('Http')) config.httpApiComponent = true;
						if (value.contains('MessageArchiving')) config.messageArchivingComponent = true;
					} else if ('--sm-plugins'.equals(key)) {
						if (!config.plugins) config.plugins = [];
						props.get(key).split(',').each {
							def itkey = (it.startsWith('-') || it.startsWith('+')) ? it.substring(1, it.length()) : it;
							itkey = itkey.replaceAll("\\:",":");
							config.plugins.add([key:itkey, value:(!it.startsWith('-'))]);
						}
					} else if ('--debug'.equals(key)) {
						props.get(key).split(',').collect { it + 'Debug' }.each { config[it] = true; }
					} else if ('--cluster-mode'.equals(key)) {
						config.clusterMode = "true".equals(props.get(key));
					}
				}		
				reader.close();
			}
		} else if (action == 'reset') {
			redirectUrl = request.getRequestURI() + "?" + request.getQueryString().replace('&action=reset','');
			config.clear();
		} %><html><head>
			<meta http-equiv="refresh" content="0;url=${redirectUrl}"/>
		</head><body></body></html>
		<% return;
	}
    def tmp = [
	test:1
	] + config;
    def title = 'Load configuration'
    
	tmp.each { k,v ->
		if (request.getParameter(k)) {
			Object old = tmp[k];
			if (old instanceof Boolean) {
				tmp[k] = Boolean.parseBoolean(request.getParameter(k));
			}
			else {
				tmp[k] = request.getParameter(k);
			}
		}
	}
	config.clear();
	config.putAll(tmp);
%>
${ util.include('header', [title:'Setup: ' + title]) }
<h3></h3>
<%
	def components = [];
	if (config.mucComponent) {
		def cls = 'tigase.muc.MUCComponent';
		if (config.acsMUCComponent) {
			cls = 'tigase.muc.cluster.MUCComponentClustered';
		}
		components.add([cls:cls, name:'muc']);
	}
	if (config.PubSubComponent) {
		def cls = 'tigase.pubsub.PubSubComponent';
		if (config.acsPubSubComponent) {
			cls = 'tigase.pubsub.cluster.PubSubComponentClustered';
		}
		components.add([cls:cls, name:'pubsub']);
	}
	if (config.httpApiComponent) {
		components.add([cls:'tigase.http.HttpMessageReceiver', name:'http']);
	}
	if (config.stunComponent) {
		components.add([cls:'tigase.stun.StunComponent', name:'stun']);
	}
	if (config.socks5Component) {
		components.add([cls:'tigase.socks5.Socks5Component', name:'socks5']);
	}
	if (config.messageArchivingComponent) {
		components.add([cls:'tigase.archive.MessageArchiveComponent', name:'message-archiving']);
	}
%>
<label for='config'>Current configuration of installation:</label><br/>
<textarea name='config' rows=40 cols=80>
config-type=${config.configType}
--virt-hosts=${config.virtualDomains}
--admins=${config.admins}
<% 
	def debug = "";
	if (config.serverDebug) {
		if (debug.length() > 0)
			debug += ',';
		debug += 'server';
	}
	if (config.pluginDebug) {
		if (debug.length() > 0)
			debug += ',';
		debug += 'xmpp';
	}
	if (config.dbDebug) {
		if (debug.length() > 0)
			debug += ',';
		debug += 'db';
	}
	if (config.clusterDebug) {
		if (debug.length() > 0)
			debug += ',';
		debug += 'cluster';
	}
    if (debug.length() > 0) {
 %>
--debug=${debug}
<% } %><% def dbUri = ((config.dbType?.toLowerCase()) == "derby") ? "jdbc:derby:${config.dbName};create=true"
		: "jdbc:${config.dbType?.toLowerCase()}://${config.dbHost}/${config.dbName}?user=${config.dbUser}&password=${config.dbPass}".toString(); 
	def userDbUri = dbUri.toString(); 
	def authDbUri = dbUri.toString(); %>
--user-db-uri=${userDbUri}
<% if (userDbUri != authDbUri) { %>--auth-db-uri=${authDbUri}<% } %>
<%  def plugins = "";
    config.plugins.each {
		if (plugins.length() > 0) plugins += ",";
		plugins += (it.value ? '+' : '-') + it.key.replace(':', '\\:');
	} 
%>
--sm-plugins=${plugins}
<% def ci = 1;
   components.each {
 %>
--comp-name-${ci}=${it.name}
--comp-class-${ci}=${it.cls}
<% ci++;
   } %>
</textarea>

<form method='GET' >
<input type='hidden' name='step' value='4'/>
<div style='padding-top: 1em'></div>
<button type="submit">Next</button>
<button type="button" name="reload" onclick="var idx = window.location.href.indexOf('?'); window.location=window.location.href.substring(0,idx) + '?step=${currentStep}&action=reload'">Reload from file</button>
<button type="button" name="reset" onclick="var idx = window.location.href.indexOf('?'); window.location=window.location.href.substring(0,idx) + '?step=${currentStep}&action=reset'">Reset</button>

</form>
${ util.include('footer') } 